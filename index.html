<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- <script src="bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap.min.css"> -->
	<script src="jquery.min.js"></script>
    <script src="lib/codemirror.js"></script>
    <link rel="stylesheet" href="lib/codemirror.css" />
    <link rel="stylesheet" href="theme/eclipse.css" />
    <link rel="stylesheet" href="theme/monokai.css" />
    <link rel="stylesheet" href="addon/fold/foldgutter.css" />
    <script src="mode/python/python.js"></script>
    <script src="addon/fold/foldcode.js"></script>
    <script src="addon/fold/foldgutter.js"></script>
    <script src="addon/fold/xml-fold.js"></script>
    <script src="addon/fold/indent-fold.js"></script>
    <script src="addon/fold/brace-fold.js"></script>
    <script src="addon/fold/markdown-fold.js"></script>
    <script src="addon/fold/comment-fold.js"></script>
    <script src="addon/selection/active-line.js"></script>
    <script src="addon/edit/closebrackets.js"></script>
    <script src="addon/edit/matchbrackets.js"></script>
    <script src="addon/comment/comment.js"></script>
    <script src="addon/comment/continuecomment.js"></script>
    <script src="keymap/sublime.js"></script>

    <script src="skulpt.min.js" type="text/javascript"></script>
    <script src="skulpt-stdlib.js" type="text/javascript"></script>
    <style>
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>

<body>
    <script src="bootstrap.min.js"></script>
    <link rel="stylesheet" href="bootstrap.min.css">
    <script type="text/javascript">
        function HTMLEncode(html) {
            var temp = document.createElement("div");
            (temp.textContent != null) ? (temp.textContent = html) : (temp.innerText = html);
            var output = temp.innerHTML;
            temp = null;
            return output;
        }

        function HTMLDecode(text) {
                var temp = document.createElement("div");
                temp.innerHTML = text;
                var output = temp.innerText || temp.textContent;
                temp = null;
                return output;
        }

        function chtheme() {
            var theme = document.getElementById("chtheme");
            if (theme.innerHTML == "ğŸ”†") {
                theme.innerHTML = "ğŸŒ™";
                applyTheme("monokai");
            } else {
                theme.innerHTML = "ğŸ”†";
                applyTheme("eclipse");
            }
        }

        function getQueryVariable(variable, params) {
            var query = window.location.search.substring(1);
            var vars = params.split("&");
            for (var i = 0; i < vars.length; i++) {
                var pair = vars[i].split("=");
                if (pair[0] == variable) { return pair[1]; }
            }
            return (false);
        }

        function applyBanner(banner) {
            document.getElementById('banner').innerHTML = banner;
        }

        function applyCode(code) {
            editor.getDoc().setValue(decodeURIComponent(window.atob(code)));
            // console.log(decodeURIComponent(window.atob(code)));
            editor.refresh();
        }

        function applyAction(action) {
            if (action == '1') { runit(); }
            if (action == '2') { download(); }
            else { eval(action); }
            // console.log(action);
        }

        function applyTheme(theme) {
            var themeico = document.getElementById("chtheme");
            if (theme == "monokai") {
                themeico.innerHTML = "ğŸŒ™";
            } else {
                themeico.innerHTML = "ğŸ”†";
            }
            editor.setOption("theme", theme);

            gTheme = theme;
            editor.refresh();
        }

        function saveData(theme) {
            if (typeof (Storage) != "undefined") {
                localStorage.setItem("theme", theme);
                localStorage.setItem("code", window.btoa(encodeURIComponent(editor.getValue())));
            }
        }

        function loadData() {
            if (typeof (Storage) != "undefined") {
                applyTheme(localStorage.getItem("theme"));
                applyCode(localStorage.getItem("code"));
            }
        }

        function outf(text) {
            printErrInfo('');
            var mypre = document.getElementById("output");  //
            mypre.innerHTML = mypre.innerHTML + HTMLEncode(text);  //æ–‡å­—è¾“å‡º
        }

        function statusRunning() {
            var btn = document.getElementById("runCode");
            btn.disabled = true;
            btn.setAttribute('class', 'btn btn-warning');
            btn.innerHTML = "è¿è¡Œä¸­...";
        }

        function statusSuccess() {
            var btn = document.getElementById("runCode");
            btn.disabled = false;
            btn.setAttribute('class', 'btn btn-success');
            btn.innerHTML = "è¿è¡Œ <kbd>F5</kbd>";
        }

        function statusFailed() {
            var btn = document.getElementById("runCode");
            btn.disabled = false;
            btn.setAttribute('class', 'btn btn-danger');
            btn.innerHTML = "è¿è¡Œ <kbd>F5</kbd>";
        }

        function printErrInfo(text) {
            var mypre = document.getElementById("outputErr");  //
            mypre.innerHTML = "<br />"+text;  //æ–‡å­—è¾“å‡º
        }

        function download() {
            var element = document.createElement('a');
            var text = editor.getValue();
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', 'NeglectedGarden.py');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function dispModal(title, content, act) {
            var strrand=''+Math.floor(Math.random()*1000);
            var modalWindow = document.createElement('div');
            if (title=='0') {
                strrand=0;
                modalWindow.innerHTML=content;
            } else {
                modalWindow.innerHTML='<div class="modal fade" id="tmpModal'+strrand+'"> <div class="modal-dialog"> <div style="position:relative;width:400px;height:400px;" >  <div class="modal-content"><div class="modal-header"><h4 class="modal-title">'+title+'</h4><button type="button" class="close" data-dismiss="modal">&times;</button></div><div class="modal-body">'+content+'</div><div class="modal-footer"><button type="button" class="btn btn-secondary" data-dismiss="modal">å…³é—­</button></div></div></div></div>';
            }
            document.body.appendChild(modalWindow);
            var modalButton = document.createElement('div');
            modalButton.innerHTML='<button type="button" id="showModal'+strrand+'" class="btn btn-primary" data-toggle="modal" data-target="#tmpModal'+strrand+'"> </button>';
            document.body.appendChild(modalButton);
            document.getElementById('showModal'+strrand).click();
            document.body.removeChild(modalButton);
        }

        function share(act) {
            var code = window.btoa(encodeURIComponent(editor.getValue()));
            var action = getAction(act);
            var banner = getBanner();
            var key = window.btoa('code=' + code + '&action=' + encodeURIComponent(action) + '&banner=' + encodeURIComponent(banner));
            var baseUrlEnd = window.location.href.indexOf('?') < 0 ? window.location.href.length : window.location.href.indexOf('?');
            var baseUrl = window.location.href.substring(0, baseUrlEnd);
            var sharedurl = baseUrl + '?key=' + key;
            copy(sharedurl);
            alert('é“¾æ¥å¤åˆ¶æˆåŠŸ');
        }

        var getBanner = () => {
            return 'Forgotten Forest';
            // Override this function in browser and have fun
        };

        var getAction = (act) => {
            if (act != '1' && act != '2') {
                return '0';
            }
            return act;
            // Override this function in browser and have fun
        };

        function copy(content) {
            let transfer = document.createElement('input');
            document.body.appendChild(transfer);
            transfer.value = content;
            transfer.focus();
            transfer.select();
            if (document.execCommand('copy')) {
                document.execCommand('copy');
            }
            transfer.blur();
            document.body.removeChild(transfer);

        }

        function builtinRead(x) {
            if (Sk.builtinFiles === undefined || Sk.builtinFiles["files"][x] === undefined)
                throw "File not found: '" + x + "'";
            return Sk.builtinFiles["files"][x];
        }

        function runit() {
            statusRunning();
            // console.log("runit is going");
            var prog = editor.getValue();
            
            var mypre = document.getElementById("output");   //è·å–è¾“å‡ºæ¡†
            mypre.innerHTML = '';
            Sk.pre = "output";
            Sk.configure({ output: outf, read: builtinRead, __future__: Sk.python3 });

            (Sk.TurtleGraphics || (Sk.TurtleGraphics = {})).target = 'mycanvas';
            var myPromise = Sk.misceval.asyncToPromise(function () {
                // statusRunning();
                return Sk.importMainWithBody("<stdin>", false, prog, true);
            });

            myPromise.then(function (mod) {
                // console.log('success');    //æ‰§è¡ŒæˆåŠŸï¼Œæ˜¾ç¤ºsuccess
                statusSuccess();
            },
                function (err) {
                    var mypre = document.getElementById("output");  //
                    mypre.innerHTML = "";  //æ–‡å­—è¾“å‡º
                    statusFailed();
                    printErrInfo(err.toString());
                });
        }
    </script>
    <div class="container" style="padding-left: 1px; padding-right: 1px; ">

        <div class="py-2 text-center">
            <h2 id='banner'>Forgotten Forest</h3>
                <p class="lead"><small>è¿™æ˜¯Python3çš„ç®€æ˜“æ¨¡æ‹Ÿå®éªŒå¹³å°ï¼ŒPython3çš„ä½¿ç”¨æŒ‡å—å¯ä»¥ç§»æ­¥<a
                            href="Guide.html">è¿™é‡Œ</a>ã€‚</small></p>
        </div>
        <form>
            <div class="container-fluid" style="padding-left: 1px; padding-right: 1px; ">
                <!-- textareaæ˜¯ç”¨æˆ·è¾“å…¥ä»£ç çš„éƒ¨åˆ†ï¼Œåœ¨æ­¤åŒºåŸŸå¡«å†™ä»£ç ï¼Œæ¯æ¬¡è¿è¡Œéƒ½ä¼šæ˜¾ç¤º -->
                <textarea id="yourcode" cols="80" rows="10">
        </div>
        </textarea><br />

                <div class="row">
                    <div class="col-md-6">
                        <button type="button" id="runCode"
                            style="width:125px;margin-right: 2px;margin-left: 2px;margin-top: 2px;margin-bottom: 2px;"
                            class="btn btn-success" onclick="runit()">
                            è¿è¡Œ <kbd>F5</kbd>
                        </button>
                        <button type="button" style="width:125px;margin-right: 2px;margin-left: 2px;margin-top: 2px;margin-bottom: 2px;"
                            class="btn btn-warning" onclick="download()">
                            ä¿å­˜æ–‡ä»¶
                        </button>
                        <select id="sharelink" style="width:125px;text-align:center;margin-right: 2px;margin-left: 2px;margin-top: 2px;margin-bottom: 2px;"
                            class="form-select text-center form-control btn btn-primary"
                            onclick="" onchange="eval(this.value);document.getElementById('sharelink').getElementsByTagName('option')[0].selected = true;">
                            <option value="share('0')">åˆ†äº«</option>
                            <option value="share('0')">åˆ†äº«ä»£ç </option>
                            <option value="share('1')">åˆ†äº«è¿è¡Œç»“æœ</option>
                            <option value="share('2')">åˆ†äº«ä¸‹è½½é“¾æ¥</option>
                        </select>
                        <div id="chtheme" class="btn btn-default  btn-sm" onclick="chtheme()">ğŸ”†
                        </div>
                    </div>
                    <div class="col-md-5"></div>
                </div>

                <!-- </form> -->
                <p  id="outputErr" style="color:#ee1111"></p>
                <!-- æ–‡å­—è¾“å‡ºéƒ¨åˆ† -->
                <pre><code id="output"></code></pre>
                <!-- ç”»å›¾è¾“å‡ºéƒ¨åˆ† -->
                <div id="mycanvas"></div>

            </div>

            <script type="text/javascript">
                var gTheme = "eclipse";
                document.getElementById("yourcode").innerHTML = "print('Welcome to Neglected Garden')\nprint('Welcome to Neglected Garden')";
                var editor = CodeMirror.fromTextArea(document.getElementById("yourcode"), {
                    mode: "text/x-python", //å®ç°Javaä»£ç é«˜äº®
                    keyMap: 'sublime',
                    lineNumbers: true,Â Â //æ˜¾ç¤ºè¡Œå·
                    indentUnit: 4,
                    tabSize: 4,
                    showCursorWhenSelecting: true,
                    styleActiveLine: true,
                    line: true,
                    theme: gTheme,Â //è®¾ç½®ä¸»é¢˜
                    lineWrapping: true,Â //ä»£ç æŠ˜å 
                    foldGutter: true,
                    gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                    matchBrackets: true,Â Â //æ‹¬å·åŒ¹é…
                    autoCloseBrackets: true,
                    showHint: false,
                    extraKeys: {
                        "F5": function () {
                            runit();
                        }
                    },
                    smartIndent: true
                });
                editor.setSize('auto','420px');
                editor.refresh();
                loadData();
            </script>
            <script type="text/javascript">


                var params = window.location.search.substring(1);
                if (params.length != 0) {
                    try {
                        var key = window.atob(params.split("=")[1]);
                        // console.log(key);
                        var banner = decodeURIComponent(getQueryVariable('banner', key));
                        // console.log(banner);
                        var code = getQueryVariable('code', key);
                        // console.log(code);
                        var action = decodeURIComponent(getQueryVariable('action', key));
                        // console.log(action);
                        if (banner != 'undefined' && banner != 'false') { applyBanner(banner); }
                        if (code) { applyCode(code); }
                        if (action != 'undefined' && action != 'false') { applyAction(action); }
                    } catch (err) {
                        // console.log(err);
                        alert("é“¾æ¥é”™è¯¯ï¼");
                    }
                }
                window.onbeforeunload = function () {
                    saveData(gTheme);
                    // event.returnValue='ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿä¹‹å‰çš„ä¿®æ”¹å¯èƒ½ä¼šä¸¢å¤±';
                };

                window.onunload = function () {
                    saveData(gTheme);
                    // event.returnValue='ç¡®å®šè¦ç¦»å¼€å—ï¼Ÿä¹‹å‰çš„ä¿®æ”¹å¯èƒ½ä¼šä¸¢å¤±';
                };
            </script>

<!-- getAction = (act)=>{
return "dispModal(\"0\",\"<div class=\\\"modal fade\\\" id=\\\"tmpModal0\\\" onclick=\\\"dispModal('è‡´é¦–ä½ä½¿ç”¨è€…','ä½ å¥½ï¼Œè¿™é‡Œæ˜¯Python3æ¨¡æ‹Ÿå®éªŒå¹³å°ï¼Œæ¬¢è¿ä½¿ç”¨ã€‚å¦‚æœä½ ä½œä¸ºç¬¬ä¸€åä½¿ç”¨è€…æ„Ÿåˆ°è£å¹¸ï¼Œä¸å¦‚è¯´ä½œä¸ºæ€»å¼€å‘è€…æˆ‘æ›´é«˜å…´ç¬¬ä¸€æ¬¡é‡è§çš„æ˜¯ä½ ã€‚è¿™æ˜¯æˆ‘çš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼Œåç»­è¿˜ä¼šåŠ å…¥è¯¸å¤šåŠŸèƒ½å¹¶è°ƒæ•´å¤–è§‚ç•Œé¢ï¼Œæ„¿é™ªä¼´é•¿ä¹…ã€‚<br /><br />â€” é­ç¦¹å¾· æ•¬ä¸Š')\\\"><div class=\\\"modal-dialog\\\"><div style=\\\"position:relative;width:400px;height:400px;\\\" ><img style=\\\"width:400px;height:400px\\\" src=\\\"envelop.jpg\\\" /><div style=\\\"position:absolute;width:400px;height:100px;left:0;top:0;text-align: center;\\\">è¿™é‡Œæœ‰ä¸€å°ä¿¡ï¼Œç‚¹å‡»æ‰“å¼€</div></div></div></div>\");";} -->
<!-- 
<script>
    function HTMLEncode(html) {
      var temp = document.createElement("div");
      (temp.textContent != null) ? (temp.textContent = html) : (temp.innerText = html);
      var output = temp.innerHTML;
      temp = null;
      return output;
    }
    function HTMLDecode(text) {
      var temp = document.createElement("div");
      temp.innerHTML = text.replace(/\u200B/g,'');
      var output = temp.innerText || temp.textContent;
      temp = null;
      return output;
    }
    function runCode(code) {
      var baseUrl = 'index.html';
      var url = baseUrl + '?key=' + window.btoa('action=1&code=' + window.btoa(encodeURIComponent(HTMLDecode(HTMLEncode(code).replace(/&nbsp;/g,' ')))));
      console.log(HTMLDecode(code));
      window.open(url);
    }
    document.querySelectorAll('div.CodeMirror-scroll > div.CodeMirror-sizer').forEach(function (codeBlock) {
      var button = document.createElement('button')
      button.className = 'copy-code-button'
      button.type = 'button'
      button.innerText = 'å°è¯•è¿è¡Œ'
      button.addEventListener('click', function () {
        runCode(codeBlock.innerText)
      })
      var pre = codeBlock.parentNode
      var highlight = pre.parentNode
      highlight.appendChild(button)
    })
  </script> -->


</body>
</html>